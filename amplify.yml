version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Using Node $(node -v) and npm $(npm -v)"
        - echo "OPENROUTER_API_KEY present? ${OPENROUTER_API_KEY:+yes}" && echo "VITE_OPENROUTER_API_KEY present? ${VITE_OPENROUTER_API_KEY:+yes}"
        - if [ -n "$OPENROUTER_API_KEY" ] && [ -z "$VITE_OPENROUTER_API_KEY" ]; then export VITE_OPENROUTER_API_KEY="$OPENROUTER_API_KEY"; fi
        - if [ -n "$OPENROUTER_API_URL" ] && [ -z "$VITE_OPENROUTER_API_URL" ]; then export VITE_OPENROUTER_API_URL="$OPENROUTER_API_URL"; fi
        - echo "SUPABASE_URL present? ${SUPABASE_URL:+yes}" && echo "VITE_SUPABASE_URL present? ${VITE_SUPABASE_URL:+yes}"
        - echo "SUPABASE_ANON_KEY present? ${SUPABASE_ANON_KEY:+yes}" && echo "VITE_SUPABASE_ANON_KEY present? ${VITE_SUPABASE_ANON_KEY:+yes}"
        - if [ -n "$SUPABASE_URL" ] && [ -z "$VITE_SUPABASE_URL" ]; then export VITE_SUPABASE_URL="$SUPABASE_URL"; fi
        - if [ -n "$SUPABASE_ANON_KEY" ] && [ -z "$VITE_SUPABASE_ANON_KEY" ]; then export VITE_SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY"; fi
        - if [ -z "$VITE_SUPABASE_URL" ] || [ -z "$VITE_SUPABASE_ANON_KEY" ]; then echo "ERROR: Missing VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY. Failing build to avoid deploying broken forms."; exit 1; fi
        - npm ci --prefer-offline || npm install --prefer-offline
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**

